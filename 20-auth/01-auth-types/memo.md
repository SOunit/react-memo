# Web アプリケーションの認証方法について、ざっくり整理してみる

https://arakan-pgm-ai.hatenablog.com/entry/2021/08/23/000000

# Auth types

- basic authentication / Basic 認証
- digest authentication / ダイジェスト認証

  - http 認証
  - リクエストごとに、Authentication ヘッダが付与される
  - Authentication ヘッダには ID とパスワードが含まれている
  - 実装は簡単だが、セキュリティ面で不安

- session based authentication / セッションベース認証

  - 特徴
    - 一般的な web アプリケーションに使う
    - ステートレスな web アプリケーションにステートを持ち込む手法
    - サーバー側でアプリケーションの状態を覚えてくため、「セッション管理」を行う
    - 「セッション管理」のためにクッキーを使用する
      - アプリの状態をセッション管理で保持する
      - セッション ID で状態にアクセスする
    - 実装は比較的簡単、ユーザーにとっても使いやすい
    - セッション ID が漏洩すると終わり、対処法は以下
      - クッキー発行の際の属性に不備がないか（特に Domain、Source、HttpOnly など）
      - セッション ID を URL に保持などして Referer ヘッダから漏洩するリスクがないか
      - TLS 等で暗号化されていないためネットワークの盗聴で漏洩するリスクがないか
      - セッション ID が推測可能になっていないか（セッション管理機構の自作は NG）
    - セッションベース認証は一般的に、CSRF 攻撃に弱いので、対策が必要
  - 認証の流れ、認証の維持の方法
    - ログイン
    - セッション ID の発行
    - ブラウザにセッション ID を送る
    - セッション ID を使って、サーバーのデータにアクセス

- token based authentication / トークンベース認証

  - RestfulAPI に使う
  - セッション ID ではなくトークンを使う
  - JWT がよく使われる
    - 構成要素は以下
      - ヘッダー(Token タイプやハッシュアルゴリズムなど）
      - ペイロード（Token 生成時刻や識別子など）
      - 認証
  - 認証の流れ
    - ログイン
    - サーバでトークン生成
    - トークンをクライアントに送る
    - サーバでトークンを確認する
  - 弱点、セキュリティ対策
    - トークンのクライアントへの保存方法は適切か
    - トークンの有効期限の設定は適切か
    - JWT をリクエストで送る方法は適切か
      - JSW を送る方法
        - Authorization ヘッダなどに含める方法
          - JS からアクセスできる場所に JWT が置かれるのでよくない
        - Cookie に含める方法
          - Cookie に HttpOnly 属性をつけて JavaScript からのアクセスを止めることができるので、比較的安全
          - 推奨方法
    - Cookie を使ったセッション管理自体が CSRF 攻撃に弱いので、その対策もちゃんとやっておく必要がある
  - 自動ログイン
    - 都度、もう少しシンプルなトークンを発行
    - DB に情報を保存
    - リクエスト時に、送られたトークンを DB と比較
    - DB からデータを消すと「ログアウト」
    - やりとりの都度、新しいトークンを発行すると比較的、セキュリティ的にも強い
    - 普通のアプリケーションにも使える

- One-Time Password Authentication (OTP) / ワンタイムパスワード認証

  - 気密性の高いデータ処理が必要なアプリに使う
  - 認証の流れ
    - サーバ側でランダムコードを生成
    - `信頼できる端末`にコードを送信
    - クライアウトからコードを送信
    - サーバとクライアントで合致すれば認証

- OAuth / OAuth2 / OpenID

  - SNS 等へのシングルサインオンが必要な場合に使う

# stateful / stateless

- ステートフル
  - 入力 + 内部情報で処理して結果を返すアプリ
- ステートレス
  - 入力のみで処理して結果を返すアプリ
- サーバーは基本的にステートレス
